<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>é£›é¨°å®¶é›» - å ±ä¿®é€²åº¦æŸ¥è©¢ (ç´”å‰ç«¯ç‰ˆ)</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="staff_style.css">
  <link rel="stylesheet" href="record_detail.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* (æ–°å¢) æ¨¡æ“¬æª”æ¡ˆé è¦½çš„æ¨£å¼ */
    .mock-preview-placeholder {
      padding: 20px;
      border: 1px dashed #cba96d;
      background: #014027;
      border-radius: 4px;
      text-align: center;
      color: #f3d28c;
    }
  </style>
</head>
<body>
  <div class="navbar">
    <div class="nav-left">
      <img src="logo1.png" alt="é£›é¨°å®¶é›»logo" class="logo" />
      <span class="username">æ­¡è¿ï¼Œæœƒå“¡åå­—</span>
    </div>
    <div class="nav-right">
      <a href="home.html" class="nav-link">é¦–é </a>
      <a href="repair_pending.html" class="nav-link">å ±ä¿®</a>
      <a href="repair_checking.html" class="nav-link">å ±ä¿®é€²åº¦æŸ¥è©¢</a>
      <a href="repair_done.html" class="nav-link">ç¶­ä¿®æ­·å²ç´€éŒ„</a>
      <a href="history.html" class="nav-link">è³¼è²·ç´€éŒ„</a>
      <a href="info.html" class="nav-link">æœƒå“¡è³‡æ–™</a>
      <a href="#" class="nav-link" onclick="logout()">ç™»å‡º</a>
    </div>
    <div class="mobile-menu">
        <button id="menu-toggle">â˜°</button>
        <div id="overlay1" class="menu-overlay">
            <div id="mobile-dropdown" class="mobile-dropdown">
                <a href="home.html">é¦–é </a>
                <a href="repair_pending.html">å ±ä¿®</a>
                <a href="repair_checking.html">å ±ä¿®é€²åº¦æŸ¥è©¢</a>
                <a href="repair_done.html">ç¶­ä¿®æ­·å²ç´€éŒ„</a>
                <a href="history.html">è³¼è²·æ­·å²</a>
                <a href="info.html">æœƒå“¡è³‡æ–™</a>
                <a href="#" onclick="logout()">ç™»å‡º</a>
            </div>
        </div>
    </div>
  </div>

  <div class="page-title">å ±ä¿®é€²åº¦æŸ¥è©¢</div>
  <div class="record-grid" id="recordGrid"></div>

  <div class="detail-overlay" id="overlay"></div>
  <div class="detail-modal" id="detailModal">
    <button class="close-icon" id="close-detail">âœ–</button>
    <h3>è©³ç´°å ±ä¿®å…§å®¹</h3>
    <div id="detailContent"></div>
  </div>
  
  <a href="home.html" class="back-button">â† å›é¦–é </a>
  
  <script>
      // ç‹€æ…‹å°ç…§ (ä¾†è‡ª 1.html)
      const statusMap = {
        "1": "å·²å®Œæˆå ±ä¿®",
        "2": "å·²å®‰æ’ç‰©æµæ”¶è²¨",
        "3": "æª¢æ¸¬ä¸­",
        "4": "å ±åƒ¹",
        "5": "è­°åƒ¹",
        "6": "è³¼è²·æ–°å“",
        "7": "å ±å»¢",
        "8": "ç¶­ä¿®ä¸­",
        "9": "ç”¢å“é€å›",
        "10": "é€è²¨",
        "11": "çµæ¡ˆ"
      };

      // (*** æ–°å¢ ***) æ¨¡æ“¬å¾Œç«¯ API å›å‚³çš„å‡è³‡æ–™
      function getMockRepairHistory() {
        return [
          {
            Repair_No: 'FT20250820004',
            Name: 'å¼µå°èŠ¬',
            Product_Name: 'å¾®æ³¢çˆ',
            Product_SN: 'FT004',
            Repair_Date: '2025-08-20',
            Repair_Status: '5', // è­°åƒ¹
            Fault_Description: 'æŒ‰ä¸‹é–‹å§‹éµæ²’æœ‰åæ‡‰',
            Telphone: '0965432187',
            Place_Name: 'é«˜é›„åº—',
            Product_Price: '1800',
            Order_Date: '2024-09-10',
            Repair_Method: 'é›»è©±å ±ä¿®',
            Repair_Type: 'å®…é…',
            Adress: 'é«˜é›„å¸‚XXå€XXè·¯XXè™Ÿ',
            Contact_Details: 'å®¢æˆ¶ä¾†é›»èªªæŒ‰ä¸‹é–‹å§‹éµæ²’æœ‰åæ‡‰',
            Receive_Date: '2025-08-21',
            Test_Date: '2025-08-22',
            Agree_Date: '2025-08-23 10:30',
            Arrival_Date: '2025-08-24',
            Inspection_Desc: 'TEST_FILE_ID_123', // æª¢æ¸¬å…§å®¹æª”æ¡ˆID
            Maintenance_Desc: '', // ç¶­ä¿®å…§å®¹æª”æ¡ˆID
            Parts_Desc: 'PART_FILE_ID_456', // é›¶ä»¶æ˜ç´°æª”æ¡ˆID
            Invoice_Desc: 'INVOICE_FILE_ID_789', // ç™¼ç¥¨æª”æ¡ˆID
            Fees_Desc: 'QUOTE_FILE_ID_101', // å ±åƒ¹å–®æª”æ¡ˆID
            Receive_Fee: '150',
            Test_Fee: '300',
            Repair_Fee: '800',
            Clean_Fee: '0',
            Parts_Fee: '1200',
            Onside_Fee: '0',
            Total_Fee: '2450', // ç¨…å¾Œ
            Tax_Fee: '117', // ç¨…
            Discount: '0',
            Total_Amount: '2450' // å¯¦æ”¶
          },
          {
            Repair_No: 'FT20250815003',
            Name: 'æå¤§è¯',
            Product_Name: 'çƒ¤ç®±',
            Product_SN: 'FT003',
            Repair_Date: '2025-08-15',
            Repair_Status: '8', // ç¶­ä¿®ä¸­
            Fault_Description: 'æº«åº¦æ§åˆ¶ç•°å¸¸',
            Telphone: '0987654321',
            Place_Name: 'å°ä¸­åº—',
            Product_Price: '4500',
            Order_Date: '2024-10-20',
            Repair_Method: 'ç·šä¸Šå ±ä¿®',
            Repair_Type: 'é–€å¸‚é€ä»¶',
            Adress: 'å°ä¸­å¸‚XXå€XXè·¯XXè™Ÿ',
            Contact_Details: 'å®¢æˆ¶åæ˜ çƒ¤ç®±æº«åº¦ä¸æº–ç¢º',
            Receive_Date: '2025-08-16',
            Test_Date: '2025-08-17',
            Agree_Date: '',
            Arrival_Date: '',
            Inspection_Desc: 'TEST_FILE_ID_ABC',
            Maintenance_Desc: 'MAINT_FILE_ID_DEF',
            Parts_Desc: '',
            Invoice_Desc: '',
            Fees_Desc: '',
            Receive_Fee: '0',
            Test_Fee: '300',
            Repair_Fee: '1000',
            Clean_Fee: '100',
            Parts_Fee: '1500',
            Onside_Fee: '0',
            Total_Fee: '2900',
            Tax_Fee: '138',
            Discount: '0',
            Total_Amount: '2900'
          },
          {
            Repair_No: 'FT20250803006',
            Name: 'æ—å°è¯',
            Product_Name: 'æ´—è¡£æ©Ÿ',
            Product_SN: 'FT006',
            Repair_Date: '2025-08-03',
            Repair_Status: '11', // çµæ¡ˆ
            Fault_Description: 'æ’æ°´ç•°å¸¸',
            Telphone: '0934567890',
            Place_Name: 'å°å—åº—',
            Product_Price: '15000',
            Order_Date: '2024-10-15',
            Repair_Method: 'LINEè¯çµ¡',
            Repair_Type: 'å®…é…',
            Adress: 'å°å—å¸‚XXå€XXè·¯XXè™Ÿ',
            Contact_Details: 'å·²å®Œæˆç¶­ä¿®ä¸¦é€å›å®¢æˆ¶ï¼Œæ¡ˆä»¶çµæ¡ˆ',
            Receive_Date: '2025-08-04',
            Test_Date: '2025-08-05',
            Agree_Date: '2025-08-06 14:00',
            Arrival_Date: '2025-08-08',
            Inspection_Desc: '',
            Maintenance_Desc: '',
            Parts_Desc: 'PART_FILE_ID_777',
            Invoice_Desc: 'INVOICE_FILE_ID_888',
            Fees_Desc: 'QUOTE_FILE_ID_999',
            Receive_Fee: '300',
            Test_Fee: '500',
            Repair_Fee: '1500',
            Clean_Fee: '0',
            Parts_Fee: '800',
            Onside_Fee: '0',
            Total_Fee: '3100',
            Tax_Fee: '148',
            Discount: '0',
            Total_Amount: '3100'
          }
        ];
      }
    
      // (*** æ›¿æ› ***) ç§»é™¤ API å‘¼å«ï¼Œæ”¹ç”¨æœ¬åœ° Mock è³‡æ–™
      window.onload = function () {
          const phone = localStorage.getItem('userName');
          if (!phone) {
              // æ¨¡æ“¬ç™»å…¥ï¼Œæ–¹ä¾¿æ¸¬è©¦
              console.log("æœªç™»å…¥ï¼Œæ¨¡æ“¬ç™»å…¥ 'demo_user'");
              localStorage.setItem('userName', 'demo_user');
              // alert('è«‹å…ˆç™»å…¥');
              // window.location.href = 'index.html';
              // return;
          }
      
          const container = document.querySelector('#recordGrid');
          container.innerHTML = '<p>è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...</p>';
      
          try {
              // (æ›¿æ›) å‘¼å«æœ¬åœ° MOCK å‡½æ•¸ï¼Œä¸å† fetch
              const result = getMockRepairHistory();
              console.log('Mock è³‡æ–™ï¼š', result);
      
              // 5. è™•ç†è³‡æ–™
              if (Array.isArray(result) && result.length > 0) {
                  container.innerHTML = '';
                  // (ä¿®æ”¹) ç§»é™¤ .reverse()ï¼Œè®“è³‡æ–™ç…§å‡è³‡æ–™çš„é †åº
                  result.forEach((repairhistory, index) => {
                      const repairBox = document.createElement('div');
                      repairBox.className = 'info-box';
                      repairBox.innerHTML = `
                      <p>å ±ä¿®å–®è™Ÿï¼š${repairhistory.Repair_No || ''}</p>
                      <p>å®¢æˆ¶å§“åï¼š${repairhistory.Name || ''}</p>
                      <p>å ±ä¿®ç”¢å“åç¨±ï¼š${repairhistory.Product_Name || ''}</p>
                      <p>å ±ä¿®ç”¢å“åºè™Ÿï¼š${repairhistory.Product_SN || ''}</p>
                      <p>å ±ä¿®æ—¥æœŸï¼š${repairhistory.Repair_Date || ''}</p>
                      <p>å ±ä¿®ç‹€æ…‹ï¼š${statusMap[repairhistory.Repair_Status] || repairhistory.Repair_Status || repairhistory.status}</p>
                      <p>æ•…éšœæè¿°ï¼š${repairhistory.Fault_Description || ''}</p>
                      ${generateStatusProgress(repairhistory.Repair_Status)}
                      <button class="show-detail" data-index="${index}">æŸ¥çœ‹æ‰€æœ‰å…§å®¹</button>
                      <hr>
                      `;
                      container.appendChild(repairBox);
                  });
                
                  bindDetailButtons(result);
                
              } else {
                  document.querySelector('#recordGrid').innerHTML = '<p>æŸ¥ç„¡å ±ä¿®è³‡æ–™</p>';
              }
          } catch (error) {
              console.error('æŸ¥è©¢å¤±æ•—:', error);
              document.querySelector('#recordGrid').innerHTML = '<p>ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦</p>';
          }
      }

    const modal = document.getElementById('detailModal');
    const overlay = document.getElementById('overlay');
    const closeBtn = document.getElementById('close-detail');
    
    closeBtn.addEventListener('click', () => {
      overlay.classList.remove('active');
      modal.classList.remove('active');
    });
    overlay.addEventListener('click', () => {
      overlay.classList.remove('active');
      modal.classList.remove('active');
    });

    /* === Modal (ä¾†è‡ª 1.html çš„ 5 åˆ†é ç‰ˆæœ¬) === */
    function bindDetailButtons(list) {
      const overlay = document.getElementById('overlay');
      const modal = document.getElementById('detailModal');
      const closeBtn = document.getElementById('close-detail');
      const detailBtns = document.querySelectorAll('.show-detail');
      const detailContent = document.getElementById('detailContent');

      detailBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const i = +btn.getAttribute('data-index');
          const data = list[i];

          let invoiceParts = ["", "", "", ""];
          if (data.Invoice_Desc) {
            invoiceParts = data.Invoice_Desc.split("-");
          }
          
          detailContent.innerHTML = `
            <div class="detail-tabs" style="display: flex; justify-content: space-between; width: 100%; max-width: 420px; margin: 0 auto 20px; border-bottom: 1px solid #ebd7b5;">
              <button class="detail-tab-button active" id="repair-content-tab" style="flex: 1; padding: 10px 0; font-size: 16px; background-color: transparent; color: #f3d28c; border: none; border-bottom: 2px solid #cba96d; cursor: pointer; transition: border-bottom 0.3s ease, color 0.3s ease;">å ±ä¿®å…§å®¹</button>
              <button class="detail-tab-button inactive" id="inspection-content-tab" style="flex: 1; padding: 10px 0; font-size: 16px; background-color: transparent; color: #797777; border: none; border-bottom: 2px solid transparent; cursor: pointer; transition: border-bottom 0.3s ease, color 0.3s ease;">æª¢æ¸¬å…§å®¹</button>
              <button class="detail-tab-button inactive" id="maintenance-content-tab" style="flex: 1; padding: 10px 0; font-size: 16px; background-color: transparent; color: #797777; border: none; border-bottom: 2px solid transparent; cursor: pointer; transition: border-bottom 0.3s ease, color 0.3s ease;">ç¶­ä¿®å…§å®¹</button>
              <button class="detail-tab-button inactive" id="quotation-process-tab" style="flex: 1; padding: 10px 0; font-size: 16px; background-color: transparent; color: #797777; border: none; border-bottom: 2px solid transparent; cursor: pointer; transition: border-bottom 0.3s ease, color 0.3s ease;">å ±åƒ¹éç¨‹</button>
              <button class="detail-tab-button inactive" id="invoice-tab" style="flex: 1; padding: 10px 0; font-size: 16px; background-color: transparent; color: #797777; border: none; border-bottom: 2px solid transparent; cursor: pointer; transition: border-bottom 0.3s ease, color 0.3s ease;white-space: nowrap;">å ±åƒ¹å–®èˆ‡ç™¼ç¥¨</button>
            </div>

            <div id="repair-content-section" class="detail-section">
              <p>å ±ä¿®å–®è™Ÿï¼š${data.Repair_No}</p>
              <p>å ±ä¿®ç‹€æ…‹ï¼š${statusMap[data.Repair_Status] || data.Repair_Status || data.status}</p>
              <p>æœƒå“¡å§“åï¼š${data.Name || ''}</p>
              <p>é›»è©±è™Ÿç¢¼ï¼š${data.Telphone || ''}</p>
              <p>å ±ä¿®ç”¢å“ï¼š${data.Product_Name || ''}</p>
              <p>ç”¢å“åºè™Ÿï¼š${data.Product_SN || ''}</p>
              <p>è³¼è²·åœ°é»ï¼š${data.Place_Name}</p>
              <p>è³¼è²·åƒ¹æ ¼ï¼š${data.Product_Price}</p>
              <p>è³¼è²·æ—¥æœŸï¼š${data.Order_Date}</p>
              <p>å ±ä¿®æ–¹å¼ï¼š${data.Repair_Method || ''}</p>
              <p>é€ä¿®æ–¹å¼ï¼š${data.Repair_Type || ''}</p>
              <p>æ”¶ä»¶åœ°å€ï¼š${data.Adress || ''}</p>
              <p>æ•…éšœæè¿°ï¼š${data.Fault_Description || ''}</p>
              <p>å ±ä¿®é€£çµ¡å…§å®¹ï¼š${data.Contact_Details || ''}</p>
              <p>å ±ä¿®æ—¥æœŸï¼š${data.Repair_Date || ''}</p>
              <p>æ”¶è²¨æ—¥æœŸï¼š${data.Receive_Date || ''}</p>
              <p>æª¢æ¸¬æ—¥æœŸï¼š${data.Test_Date || ''}</p>
              <p>åŒæ„è­°åƒ¹æ™‚é–“ï¼š${data.Agree_Date || ''}</p>
              <p>è²¨ç‰©æŠµé”æ—¥ï¼š${data.Arrival_Date || ''}</p>
            </div>

            <div id="inspection-content-section" class="edit-section" style="display: none;">
              <input type="hidden" class="fileIdInput" />
              <div class="fileResult"></div>
              <img class="previewImg" alt="é è¦½" style="display:none; max-width:400px; margin-top:10px;" />
              <div class="previewPdfContainer" style="display:none; margin-top:10px;"></div>
            </div>

            <div id="maintenance-content-section" class="edit-section" style="display: none;">
              <input type="hidden" class="fileIdInput" />
              <div class="fileResult"></div>
              <img class="previewImg" alt="é è¦½" style="display:none; max-width:400px; margin-top:10px;" />
              <div class="previewPdfContainer" style="display:none; margin-top:10px;"></div>
            </div>
            
            <div id="quotation-process-section" class="detail-section" style="display: none;">
              <p>é‹è²»å ±åƒ¹ï¼š${data.Receive_Fee || ''}</p>
              <p>æª¢æ¸¬è²»ç”¨ï¼š${data.Test_Fee || ''}</p>
              <p>ç¶­ä¿®å·¥è³‡ï¼š${data.Repair_Fee || ''}</p>
              <p>æ¸…æ½”è²»ç”¨ï¼š${data.Clean_Fee || ''}</p>
              <p>é›¶ä»¶è²»ç”¨ï¼š${data.Parts_Fee || ''}</p>
              <p>åˆ°åºœæœå‹™è²»ç”¨ï¼š${data.Onside_Fee || ''}</p>
              <p>ç¶­ä¿®ç¸½é‡‘é¡ï¼ˆç¨…å¾Œï¼‰ï¼š${data.Total_Fee || ''}</p>
              <p>ç‡Ÿæ¥­ç¨…ï¼ˆ5%ï¼‰ï¼š${data.Tax_Fee || ''}</p>
              <p>æŠ˜æ‰£é‡‘é¡ï¼š${data.Discount || ''}</p>
              <p>å¯¦æ”¶å„ªæƒ åƒ¹ï¼š${data.Total_Amount || ''}</p>

              <hr style="margin: 15px 0;">
              <p style="font-weight: bold;">é›¶ä»¶æ˜ç´°èªªæ˜</p>
              
              <div id="parts-section" class="upload-section">
                <input type="hidden" class="fileIdInput" />
                <div class="fileResult"></div>
                <img class="previewImg" alt="é è¦½" style="display:none; max-width:400px; margin-top:10px;" />
                <div class="previewPdfContainer" style="display:none; margin-top:10px;"></div>
              </div>
            </div>

            <div id="invoice-section" class="upload-section" style="display: none;">
              <div id="invoiceFileSection" class="upload-section" style="margin-bottom: 20px;">
                <p style="margin-bottom: 5px;">ç™¼ç¥¨æ˜ç´°ï¼š</p>
                <input type="hidden" class="fileIdInput" /> 
                <div class="fileResult"></div>
                <img class="previewImg" alt="é è¦½" style="display:none; max-width:400px; margin-top:10px;" />
                <div class="previewPdfContainer" style="display:none; margin-top:10px;"></div>
              </div>
              <div id="feesFileSection" class="upload-section">
                <p style="margin-bottom: 5px;">å ±åƒ¹å–®ï¼š</p>
                <input type="hidden" class="fileIdInput" id="feesFileId" /> 
                <div class="fileResult"></div>
                <img class="previewImg" alt="é è¦½" style="display:none; max-width:400px; margin-top:10px;" />
                <div class="previewPdfContainer" style="display:none; margin-top:10px;"></div>
              </div>
            </div> 
          `;
          
          // ç¶å®šåˆ‡æ›åŠŸèƒ½
          bindDetailTabSwitching();
          // (ä¿®æ”¹) å‘¼å«æ¨¡æ“¬çš„æª”æ¡ˆè¼‰å…¥
          loadAllDetailFiles(data);
          overlay.classList.add('active');
          modal.classList.add('active');
        });
      });

      closeBtn.addEventListener('click', () => {
        overlay.classList.remove('active');
        modal.classList.remove('active');
      });
      overlay.addEventListener('click', () => {
        overlay.classList.remove('active');
        modal.classList.remove('active');
      });
    }

    /* === Modal å…§éƒ¨åˆ‡æ›åŠŸèƒ½ === */
    function bindDetailTabSwitching() {
      const repairContentTab = document.getElementById("repair-content-tab");
      const inspectionContentTab = document.getElementById("inspection-content-tab");
      const maintenanceContentTab = document.getElementById("maintenance-content-tab");
      const quotationProcessTab = document.getElementById("quotation-process-tab");
      const invoiceTab = document.getElementById("invoice-tab");

      const repairContentSection = document.getElementById('repair-content-section');
      const inspectionContentSection = document.getElementById('inspection-content-section');
      const maintenanceContentSection = document.getElementById('maintenance-content-section');
      const quotationProcessSection = document.getElementById('quotation-process-section');
      const invoiceSection = document.getElementById('invoice-section');

      function switchDetailTab(tabName) {
        const tabs = {
          repair: repairContentTab,
          inspection: inspectionContentTab,
          maintenance: maintenanceContentTab,
          quotation: quotationProcessTab,
          invoice: invoiceTab
        };

        const sections = {
          repair: repairContentSection,
          inspection: inspectionContentSection,
          maintenance: maintenanceContentSection,
          quotation: quotationProcessSection,
          invoice: invoiceSection
        };

        // é‡ç½®æ‰€æœ‰æ¨™ç±¤ç‚º inactive ç‹€æ…‹
        Object.values(tabs).forEach(tab => {
          if (tab) {
            tab.className = "detail-tab-button inactive";
            tab.style.color = "#797777";
            tab.style.borderBottom = "2px solid transparent";
          }
        });

        // éš±è—æ‰€æœ‰å€å¡Š
        Object.values(sections).forEach(section => {
          if (section) {
            section.style.display = "none";
          }
        });

        // æ¿€æ´»é¸ä¸­çš„æ¨™ç±¤å’Œå€å¡Š
        if (tabs[tabName] && sections[tabName]) {
          tabs[tabName].className = "detail-tab-button active";
          tabs[tabName].style.color = "#f3d28c";
          tabs[tabName].style.borderBottom = "2px solid #cba96d";
          sections[tabName].style.display = "block";
        }
      }

      // ç¶å®šé»æ“Šäº‹ä»¶
      if (repairContentTab) repairContentTab.addEventListener('click', () => switchDetailTab('repair'));
      if (inspectionContentTab) inspectionContentTab.addEventListener('click', () => switchDetailTab('inspection'));
      if (maintenanceContentTab) maintenanceContentTab.addEventListener('click', () => switchDetailTab('maintenance'));
      if (quotationProcessTab) quotationProcessTab.addEventListener('click', () => switchDetailTab('quotation'));
      if (invoiceTab) invoiceTab.addEventListener('click', () => switchDetailTab('invoice'));
    }

    const MAIN_STEPS = ['å·²å®Œæˆå ±ä¿®', 'å·²å®‰æ’ç‰©æµæ”¶è²¨', 'æª¢æ¸¬ä¸­', 'å ±åƒ¹', 'è­°åƒ¹'];
    const BRANCH_CHOICES = ['è³¼è²·æ–°å“', 'å ±å»¢', 'ç¶­ä¿®ä¸­'];
    const DELIVERY_STEP = 'é€è²¨';
    const FINAL_STEP = 'ç”¢å“é€å›';
    const CLOSE_STEP = 'çµæ¡ˆ';

    function generateStatusProgress(repairStatusCode) {
      const current = statusMap[repairStatusCode];
    
      const inMainIdx   = MAIN_STEPS.indexOf(current);
      const inBranchIdx = BRANCH_CHOICES.indexOf(current);
      const inFinal     = (repairStatusCode === "9");
      const inDelivery  = (repairStatusCode === "10");
      const inClose     = (repairStatusCode === "11");
    
      // ä¸»ç·šé€²åº¦é‚è¼¯ï¼šè‹¥ä¸åœ¨ä¸»ç·šï¼Œä¸»ç·šå…¨è¦–ç‚ºå®Œæˆ
      const mainCompleted = (inBranchIdx >= 0 || inDelivery || inFinal || inClose);
      const mainActiveIdx = MAIN_STEPS.indexOf(current);
    
      // === ä¸Šæ’ï¼ˆä¸»ç·š 1~5ï¼‰ ===
      let mainHTML = '<div class="track main">';
      MAIN_STEPS.forEach((step, i) => {
        let cls = 'node';
        if (mainCompleted) cls += ' completed';
        else if (mainActiveIdx > i && mainActiveIdx >= 0) cls += ' completed';
        else if (mainActiveIdx === i) cls += ' active';
        mainHTML += `<div class="${cls}"><div class="dot">${i+1}</div><div class="label">${step}</div></div>`;
      });
      mainHTML += '</div>';
    
      // === ä¸­æ’ï¼ˆåˆ†æ”¯ï¼Œæ•¸å­—å›ºå®š 6ï¼‰ ===
      let branchHTML = '<div class="track branch">';
      BRANCH_CHOICES.forEach((step, i) => {
        let cls = 'node';
        if (inBranchIdx === i) cls += ' active';
        if ((inDelivery && step === 'è³¼è²·æ–°å“') ||
          (inFinal && step === 'ç¶­ä¿®ä¸­') ||
          (inClose && (step === 'è³¼è²·æ–°å“' || step === 'ç¶­ä¿®ä¸­' || step === 'å ±å»¢'))) cls += ' completed'; 
        branchHTML += `<div class="${cls}"><div class="dot">6</div><div class="label">${step}</div></div>`;
      });
      branchHTML += '</div>';
    
      // ä¸‹æ’ï¼šæ•¸å­— 7ï¼Œé€è²¨åœ¨ã€Œè³¼è²·æ–°å“ã€ä¸‹æ–¹ï¼Œç”¢å“é€å›åœ¨ã€Œç¶­ä¿®ä¸­ã€ä¸‹æ–¹ï¼Œå ±å»¢ä¸‹æ–¹ç©ºç™½
      let finalHTML = '<div class="track final">';
      let deliveryCls = 'node';
      if (inDelivery) deliveryCls += ' active';
      if (inClose) deliveryCls += ' completed';
      finalHTML += `<div class="${deliveryCls}"><div class="dot">7</div><div class="label">${DELIVERY_STEP}</div></div>`;
      // ç©ºç™½ç¯€é»ï¼ˆåœ¨ç¬¬äºŒæ¬„ï¼Œå ±å»¢ä¸‹æ–¹ï¼‰
      finalHTML += `<div class="node spacer"></div>`;
      // ç”¢å“é€å›ç¯€é»ï¼ˆåœ¨ç¬¬ä¸‰æ¬„ï¼Œç¶­ä¿®ä¸­ä¸‹æ–¹ï¼‰
      let finalCls = 'node is-final';
      if (inFinal) finalCls += ' active';
      if (inClose) finalCls += ' completed';
      finalHTML += `<div class="${finalCls}"><div class="dot">7</div><div class="label">${FINAL_STEP}</div></div>`;
      finalHTML += '</div>';

      // ç¬¬å››æ’ï¼šæ•¸å­— 8ï¼Œçµæ¡ˆ - åªé¡¯ç¤ºä¸€å€‹åœ¨ä¸­é–“
      let closeHTML = '<div class="track close">';
      closeHTML += `<div class="node spacer"></div>`;
      let closeCls = 'node is-final';
      if (inClose) closeCls += ' active';
      closeHTML += `<div class="${closeCls}"><div class="dot">8</div><div class="label">${CLOSE_STEP}</div></div>`;
      closeHTML += `<div class="node spacer"></div>`;
      closeHTML += '</div>';
      
      return `<div class="three-track-progress">${mainHTML}<div class="branch-connector"></div>${branchHTML}${finalHTML}<div class="final-to-close-connector"></div>${closeHTML}</div>`;
    }

    // (*** æ›¿æ› ***) æ¨¡æ“¬è¼‰å…¥æª”æ¡ˆé è¦½
    // é€™å€‹å‡½æ•¸ä¸å†çœŸçš„å» Google Drive æŠ“æª”æ¡ˆï¼Œåªæ˜¯é¡¯ç¤ºå‡çš„å¤–è§€
    async function loadFilePreview(fileId, section) {
      if (!fileId) return;

      const img = section.querySelector('.previewImg');
      const pdfContainer = section.querySelector('.previewPdfContainer');
      const resultDiv = section.querySelector('.fileResult');

      // é¡¯ç¤ºä¸€å€‹å‡çš„é€£çµ
      resultDiv.innerHTML = `ğŸ“<a href="#" onclick="alert('ç´”å‰ç«¯å±•ç¤ºæ¨¡å¼ï¼Œæª”æ¡ˆ ID: ${fileId}'); return false;" style="color: #f3d28c; font-weight: bold; text-decoration: underline;">æ¨¡æ“¬æŸ¥çœ‹æª”æ¡ˆ (ID: ${fileId})</a>`;
      img.style.display = 'none';
      pdfContainer.style.display = 'none';
      pdfContainer.innerHTML = '';

      // æ ¹æ“šå‡ ID æ±ºå®šè¦é¡¯ç¤ºåœ–ç‰‡é‚„æ˜¯ PDF ä½”ä½ç¬¦
      if (fileId.startsWith('TEST_FILE') || fileId.startsWith('PART_FILE')) {
        img.src = "https://via.placeholder.com/400x300.png?text=Mock+Image+Preview"; // å‡åœ–ç‰‡
        img.style.display = 'block';
      } else if (fileId.startsWith('INVOICE_FILE') || fileId.startsWith('QUOTE_FILE') || fileId.startsWith('MAINT_FILE')) {
        pdfContainer.innerHTML = '<div class="mock-preview-placeholder">é€™æ˜¯ä¸€å€‹æ¨¡æ“¬çš„ PDF é è¦½</div>'; // å‡ PDF
        pdfContainer.style.display = 'block';
      }
    }

    /* === è¼‰å…¥æ‰€æœ‰æª”æ¡ˆé è¦½ (ä¸»å‡½æ•¸ä¸è®Š) === */
    async function loadAllDetailFiles(record) {
      const partsSection = document.getElementById('parts-section');
      if (partsSection && record.Parts_Desc) {
        partsSection.querySelector('.fileIdInput').value = record.Parts_Desc;
        await loadFilePreview(record.Parts_Desc, partsSection);
      }
      const inspectionSection = document.getElementById('inspection-content-section');
      const inspectionFileId = record.Inspection_Desc || '';
      if (inspectionSection && inspectionFileId) {
          await loadFilePreview(inspectionFileId, inspectionSection);
      }
      const maintenanceSection = document.getElementById('maintenance-content-section');
      const maintenanceFileId = record.Maintenance_Desc || '';
      if (maintenanceSection && maintenanceFileId) {
          await loadFilePreview(maintenanceFileId, maintenanceSection);
      }
      
      const invoiceFileSection = document.getElementById('invoiceFileSection');
      if (invoiceFileSection && record.Invoice_Desc) {
          invoiceFileSection.querySelector('.fileIdInput').value = record.Invoice_Desc;
          await loadFilePreview(record.Invoice_Desc, invoiceFileSection);
      }
      
      const feesFileSection = document.getElementById('feesFileSection');
      const feesFileId = record.Fees_Desc || '';
      if (feesFileSection && feesFileId) {
          feesFileSection.querySelector('.fileIdInput').value = feesFileId;
          await loadFilePreview(feesFileId, feesFileSection);
      }
    }
    
  </script>
  
  <script src="logout.js"></script>
  
  <script>
    const toggleButton = document.getElementById('menu-toggle');
    const dropdown = document.getElementById('mobile-dropdown');
    const overlay1 = document.getElementById('overlay1');

    toggleButton.addEventListener('click', () => {
      dropdown.classList.toggle('active'); // åˆ‡æ›å³å´é¸å–®
      overlay1.classList.toggle('active');
    });

    overlay1.addEventListener('click', (event) => {
      // åªæœ‰é»æ“Šåˆ° overlay èƒŒæ™¯ï¼ˆè€Œéé¸å–®æœ¬èº«ï¼‰æ‰è§¸ç™¼é—œé–‰
      if (event.target === overlay1) {
        dropdown.classList.remove('active');
        overlay1.classList.remove('active');
      }
    });
  </script>
  
  <script src="welcome-username.js"></script>
</body>
</html>
