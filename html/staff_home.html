<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>飛騰家電 - 員工管理</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="staff_style.css" />
  <link rel="stylesheet" href="record_detail.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    input.is-invalid { border-color: #d33 !important; box-shadow: 0 0 0 2px rgba(221,51,51,.12); }
    .inline-btn { margin-left: 6px; font-size: 12px; cursor: pointer; text-decoration: underline; background: none; border: 0; color: inherit; }
  </style>
</head>
<body>
  <div class="container">
    <h2 class="page-title">員工管理系統</h2>

    <div class="search-panel">
      <div class="form-group">
        <label for="name">顧客姓名：</label>
        <input type="text" id="name" placeholder="可留空" />
      </div>

      <div class="form-group">
        <label for="phone">電話號碼：</label>
        <input type="text" id="phone" placeholder="可留空" />
      </div>

      <div class="form-group">
        <label for="repairId">報修單號：</label>
        <input type="text" id="repairId" placeholder="可留空" />
      </div>

      <div class="form-group">
        <label>日期區間：</label>
        <input type="date" id="startDate" />
        <button type="button" class="inline-btn" id="startToggle">手動輸入</button>
        ~
        <input type="date" id="endDate" />
        <button type="button" class="inline-btn" id="endToggle">手動輸入</button>
      </div>

      <div class="btn-group">
        <button class="submit-button" onclick="search()">查詢</button>
        <a href="index.html" class="submit-button">回登入頁</a>
      </div>
    </div>

    <div class="result-box" id="result" style="display: none;">
      <h3>查詢結果：</h3>
      <div class="record-grid" id="recordGrid"></div>
    </div>

    <!-- 詳細內容 Modal -->
    <div class="detail-overlay" id="overlay"></div>
    <div class="detail-modal" id="detailModal">
      <button class="close-icon" id="close-detail">✖</button>
      <h3>詳細報修內容</h3>
      <p>電話號碼：0912345678</p>
      <p>購買日期：</p>
      <p>地點：</p>
      <p>價格：</p>
      <p>報修方式：</p>
      <p>故障描述：</p>
      <p>報修聯絡內容：</p>
      
      <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #cba96d;">
        <h3>可編輯資訊：</h3>
        <p>收貨日：
          <input type="date" id="receiveDate" style="background:#ffffff;color:#000;border:1px solid #cba96d;padding:8px 12px;border-radius:4px;width:180px;margin-left:10px;font-size:16px;" />
        </p>
        <p>收貨費用：
          <input type="number" id="receiveFee" placeholder="輸入金額" style="background:#ffffff;color:#000;border:1px solid #cba96d;padding:8px 12px;border-radius:4px;width:150px;margin-left:10px;font-size:16px;" /> 元
        </p>
        <p>檢測日：
          <input type="date" id="testDate" style="background:#ffffff;color:#000;border:1px solid #cba96d;padding:8px 12px;border-radius:4px;width:180px;margin-left:10px;font-size:16px;" />
        </p>
        <p>檢測費用：
          <input type="number" id="testFee" placeholder="輸入金額" style="background:#ffffff;color:#000;border:1px solid #cba96d;padding:8px 12px;border-radius:4px;width:150px;margin-left:10px;font-size:16px;" /> 元
        </p>
        <div style="margin-top: 20px;">
          <button onclick="saveEditableFields()" style="background:#014027;color:#cba96d;border:2px solid #cba96d;padding:10px 20px;border-radius:4px;cursor:pointer;font-weight:bold;font-size:16px;">保存修改</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== 日期欄位切換：日曆 <-> 手動輸入 =====
    function toggleDateInput(id, toggleBtnId) {
      const el = document.getElementById(id);
      const btn = document.getElementById(toggleBtnId);
      btn.addEventListener('click', () => {
        if (el.type === 'date') {
          const current = el.value;
          el.type = 'text';
          el.placeholder = 'YYYY-MM-DD 或 2025/8/3';
          el.inputMode = 'numeric';
          el.value = current;
          btn.textContent = '選日曆';
        } else {
          const normalized = normalizeDateLike(el.value);
          if (normalized) el.value = normalized;
          el.classList.remove('is-invalid');
          el.type = 'date';
          el.removeAttribute('placeholder');
          el.removeAttribute('inputmode');
          btn.textContent = '手動輸入';
        }
      });
      el.addEventListener('blur', () => {
        if (el.type === 'text' && el.value) {
          const iso = normalizeDateLike(el.value);
          if (iso) { el.value = iso; el.classList.remove('is-invalid'); }
          else { el.classList.add('is-invalid'); }
        }
      });
      el.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && el.type === 'text') {
          const iso = normalizeDateLike(el.value);
          if (iso) { el.value = iso; el.classList.remove('is-invalid'); }
          else { el.classList.add('is-invalid'); }
        }
      });
      el.addEventListener('input', () => el.classList.remove('is-invalid'));
    }

    function normalizeDateLike(input) {
      if (!input) return '';
      const s = String(input).trim().replace(/\./g, '/');
      let m = s.match(/^(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})$/);
      if (m) return toISO(+m[1], +m[2], +m[3]);
      m = s.match(/^(\d{4})(\d{2})(\d{2})$/);
      if (m) return toISO(+m[1], +m[2], +m[3]);
      m = s.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})$/);
      if (m) return toISO(+m[3], +m[1], +m[2]);
      const d = new Date(s);
      if (!isNaN(d.getTime())) return toISO(d.getFullYear(), d.getMonth() + 1, d.getDate());
      return '';
    }
    function toISO(y, m, d) {
      const dt = new Date(y, m - 1, d);
      if (dt.getFullYear() !== y || dt.getMonth() !== m - 1 || dt.getDate() !== d) return '';
      return `${y.toString().padStart(4, '0')}-${m.toString().padStart(2, '0')}-${d.toString().padStart(2, '0')}`;
    }
    toggleDateInput('startDate', 'startToggle');
    toggleDateInput('endDate', 'endToggle');

    // ===== 查詢 =====
    function search() {
      const name = document.getElementById("name").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const repairId = document.getElementById("repairId").value.trim();
      const startEl = document.getElementById("startDate");
      const endEl = document.getElementById("endDate");

      if (startEl.type === 'text' && startEl.value) {
        const iso = normalizeDateLike(startEl.value);
        if (iso) startEl.value = iso;
      }
      if (endEl.type === 'text' && endEl.value) {
        const iso = normalizeDateLike(endEl.value);
        if (iso) endEl.value = iso;
      }

      const start = startEl.value;
      const end = endEl.value;

      if ((start && !end) || (!start && end)) {
        alert("請同時填寫起始與結束日期，或兩者皆留空。");
        return;
      }
      if (start && end) {
        const sd = new Date(start);
        const ed = new Date(end);
        if (sd > ed) {
          alert("起始日期不可晚於結束日期。");
          return;
        }
      }

      if (name || phone || repairId || (start && end)) {
        const mockData = generateMockData();
        displaySearchResults(mockData);
      } else {
        alert("請輸入至少一個查詢條件！");
      }
    }

    // ===== 模擬資料（示範各種狀態） =====
    function generateMockData() {
      return [
        {
          repairId: 'FT20250820004',
          productSerial: 'FT004',
          productName: '微波爐',
          repairDate: '2025-08-20',
          status: '議價',
          customerName: '張小芬',
          phone: '0965432187',
          purchaseDate: '2024-09-10',
          location: '高雄店',
          price: '1800',
          repairMethod: '電話報修',
          description: '按下開始鍵沒有反應',
          contactContent: '客戶來電說按下開始鍵沒有反應',
          receiveDate: '',
          receiveFee: '',
          testDate: '',
          testFee: ''
        },
        {
          repairId: 'FT20250815003',
          productSerial: 'FT003',
          productName: '烤箱',
          repairDate: '2025-08-15',
          status: '維修中',
          customerName: '李大華',
          phone: '0987654321',
          purchaseDate: '2024-10-20',
          location: '台中店',
          price: '4500',
          repairMethod: '線上報修',
          description: '溫度控制異常',
          contactContent: '客戶反映烤箱溫度不準確',
          receiveDate: '2025-08-16',
          receiveFee: '250',
          testDate: '',
          testFee: ''
        },
        {
          repairId: 'FT20250810002',
          productSerial: 'FT002',
          productName: '電鍋',
          repairDate: '2025-08-10',
          status: '購買新品',
          customerName: '王小明',
          phone: '0912345678',
          purchaseDate: '2024-11-15',
          location: '新竹店',
          price: '3200',
          repairMethod: '電話報修',
          description: '蒸氣閥故障',
          contactContent: '客戶來電說蒸氣無法正常排出',
          receiveDate: '2025-08-11',
          receiveFee: '150',
          testDate: '2025-08-12',
          testFee: '100'
        },
        {
          repairId: 'FT20250807001',
          productSerial: 'FT001',
          productName: '鍋',
          repairDate: '2025-08-05',
          status: '產品送回',
          customerName: '王小明',
          phone: '0912345678',
          purchaseDate: '2024-12-01',
          location: '台北店',
          price: '2500',
          repairMethod: 'APP報修',
          description: '無法正常加熱',
          contactContent: '客戶反映使用時無反應',
          receiveDate: '2025-08-06',
          receiveFee: '200',
          testDate: '2025-08-07',
          testFee: '150'
        }
      ];
    }

    // ===== 進度條（3 行版） =====
    const MAIN_STEPS = ['報修成立', '已派物流前往取貨', '檢測', '報價', '議價'];  // 1~5
    const BRANCH_CHOICES = ['購買新品', '報廢', '維修中'];                      // 顯示數字 6
    const FINAL_STEP = '產品送回';                                              // 顯示數字 7

    const STATUS_MAP = {
      '已完成報修': '報修成立',
      '已安排物流收貨': '已派物流前往取貨',
      '檢測中': '檢測',
      '報價': '報價',
      '議價': '議價',
      '購買新品': '購買新品',
      '報廢': '報廢',
      '維修中': '維修中',
      '產品送回': '產品送回'
    };
    const normalizeStatus = s => STATUS_MAP[s] || s;

    function generateStatusProgress(currentStatusRaw) {
      const current = normalizeStatus(currentStatusRaw);

      const inMainIdx   = MAIN_STEPS.indexOf(current);
      const inBranchIdx = BRANCH_CHOICES.indexOf(current);
      const inFinal     = (current === FINAL_STEP);

      // 主線：若已進入分支或到最終，主線停在「議價」
      const mainActiveIdx = (inBranchIdx >= 0 || inFinal) ? MAIN_STEPS.length - 1 : inMainIdx;

      // === 上排（主線 1~5） ===
      let mainHTML = '<div class="track main">';
      MAIN_STEPS.forEach((step, i) => {
        let cls = 'node';
        if (mainActiveIdx > i && mainActiveIdx >= 0) cls += ' completed';
        else if (mainActiveIdx === i)               cls += ' active';
        mainHTML += `<div class="${cls}"><div class="dot">${i+1}</div><div class="label">${step}</div></div>`;
      });
      mainHTML += '</div>';

      // === 中排（分支 3 選一，數字固定 6） ===
      let branchHTML = '<div class="track branch">';
      BRANCH_CHOICES.forEach((step, i) => {
        let cls = 'node';
        if (inBranchIdx === i) cls += ' active';
        // 若已到最終，將「維修中」標記為 completed（只這一個）
        if (inFinal && step === '維修中') cls += ' completed';
        branchHTML += `<div class="${cls}"><div class="dot">6</div><div class="label">${step}</div></div>`;
      });
      branchHTML += '</div>';

      // === 下排（最終 7，只在「維修中」下方） ===
      // 產生兩個空白節點 + 一個最終節點
      let finalHTML = '<div class="track final">';
      finalHTML += `<div class="node spacer"></div><div class="node spacer"></div>`;
      let finalCls = 'node is-final';
      if (inFinal) finalCls += ' active';
      finalHTML += `<div class="${finalCls}"><div class="dot">7</div><div class="label">${FINAL_STEP}</div></div>`;
      finalHTML += '</div>';

      return `<div class="three-track-progress">${mainHTML}<div class="branch-connector"></div>${branchHTML}${finalHTML}</div>`;
    }

    // ===== 顯示查詢結果 =====
    function displaySearchResults(data) {
      const sortedData = data.sort((a, b) => b.repairId.localeCompare(a.repairId));
      const recordGrid = document.getElementById('recordGrid');
      recordGrid.innerHTML = '';

      sortedData.forEach((record, index) => {
        const infoBox = document.createElement('div');
        infoBox.className = 'info-box';
        infoBox.innerHTML = `
          ${generateStatusProgress(record.status)}
          <p>維修單號：${record.repairId}</p>
          <p>產品序號：${record.productSerial}</p>
          <p>報修產品：${record.productName}</p>
          <p>報修日期：${record.repairDate}</p>
          <p>報修狀態：${record.status}</p>
          <button class="submit-button show-detail" data-index="${index}">查看所有內容</button>
        `;
        recordGrid.appendChild(infoBox);
      });

      window.currentSearchResults = sortedData;
      document.getElementById("result").style.display = "block";
      bindDetailButtons();
    }

    // ===== 詳細內容 Modal =====
    document.addEventListener('DOMContentLoaded', function() {
      const overlay = document.querySelector('.detail-overlay');
      const modal = document.querySelector('.detail-modal');
      const closeBtn = document.getElementById('close-detail');

      closeBtn.addEventListener('click', () => {
        overlay.classList.remove('active');
        modal.classList.remove('active');
      });
      overlay.addEventListener('click', () => {
        overlay.classList.remove('active');
        modal.classList.remove('active');
      });
    });

    function bindDetailButtons() {
      const detailBtns = document.querySelectorAll('.show-detail');
      const overlay = document.querySelector('.detail-overlay');
      const modal = document.querySelector('.detail-modal');

      detailBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const index = parseInt(btn.getAttribute('data-index'));
          const record = window.currentSearchResults[index];
          updateModalContent(record);
          overlay.classList.add('active');
          modal.classList.add('active');
          loadEditableFields(record);
        });
      });
    }

    function updateModalContent(record) {
      const modal = document.querySelector('.detail-modal');
      modal.innerHTML = `
        <button class="close-icon" id="close-detail">✖</button>
        <h3>詳細報修內容</h3>
        <p>電話號碼：${record.phone}</p>
        <p>購買日期：${record.purchaseDate}</p>
        <p>地點：${record.location}</p>
        <p>價格：${record.price}</p>
        <p>報修方式：${record.repairMethod}</p>
        <p>故障描述：${record.description}</p>
        <p>報修聯絡內容：${record.contactContent}</p>
        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #cba96d;">
          <h3>可編輯資訊：</h3>
          <p>收貨日：
            <input type="date" id="receiveDate" style="background:#fff;color:#000;border:1px solid #cba96d;padding:8px 12px;border-radius:4px;width:180px;margin-left:10px;font-size:16px;" />
          </p>
          <p>收貨費用：
            <input type="number" id="receiveFee" placeholder="輸入金額" style="background:#fff;color:#000;border:1px solid #cba96d;padding:8px 12px;border-radius:4px;width:150px;margin-left:10px;font-size:16px;" /> 元
          </p>
          <p>檢測日：
            <input type="date" id="testDate" style="background:#fff;color:#000;border:1px solid #cba96d;padding:8px 12px;border-radius:4px;width:180px;margin-left:10px;font-size:16px;" />
          </p>
          <p>檢測費用：
            <input type="number" id="testFee" placeholder="輸入金額" style="background:#fff;color:#000;border:1px solid #cba96d;padding:8px 12px;border-radius:4px;width:150px;margin-left:10px;font-size:16px;" /> 元
          </p>
          <div style="margin-top: 20px;">
            <button onclick="saveEditableFields()" style="background:#014027;color:#cba96d;border:2px solid #cba96d;padding:10px 20px;border-radius:4px;cursor:pointer;font-weight:bold;font-size:16px;">保存修改</button>
          </div>
        </div>
      `;
      const newCloseBtn = modal.querySelector('.close-icon');
      const overlay = document.querySelector('.detail-overlay');
      newCloseBtn.addEventListener('click', () => {
        overlay.classList.remove('active');
        modal.classList.remove('active');
      });
      window.currentRecord = record;
    }

    function loadEditableFields(record) {
      document.getElementById('receiveDate').value = record.receiveDate || '';
      document.getElementById('receiveFee').value = record.receiveFee || '';
      document.getElementById('testDate').value = record.testDate || '';
      document.getElementById('testFee').value = record.testFee || '';
    }

    function saveEditableFields() {
      const receiveDate = document.getElementById('receiveDate').value;
      const receiveFee = document.getElementById('receiveFee').value;
      const testDate = document.getElementById('testDate').value;
      const testFee = document.getElementById('testFee').value;

      if (receiveDate && testDate && new Date(receiveDate) > new Date(testDate)) {
        alert('收貨日期不能晚於檢測日期！'); return;
      }
      if ((receiveFee && receiveFee < 0) || (testFee && testFee < 0)) {
        alert('費用不能為負數！'); return;
      }

      const currentRecord = window.currentRecord;
      const repairId = currentRecord ? currentRecord.repairId : 'Unknown';

      const changes = [];
      if (receiveDate) changes.push(`收貨日: ${receiveDate}`);
      if (receiveFee)  changes.push(`收貨費用: ${receiveFee}元`);
      if (testDate)    changes.push(`檢測日: ${testDate}`);
      if (testFee)     changes.push(`檢測費用: ${testFee}元`);

      if (changes.length > 0) {
        alert(`維修單號 ${repairId} 已保存以下修改：\n` + changes.join('\n'));
        if (currentRecord) {
          currentRecord.receiveDate = receiveDate;
          currentRecord.receiveFee  = receiveFee;
          currentRecord.testDate    = testDate;
          currentRecord.testFee     = testFee;
        }
      } else {
        alert('請至少填寫一個欄位！');
      }
    }
  </script>
</body>
</html>